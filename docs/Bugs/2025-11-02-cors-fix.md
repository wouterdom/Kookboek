# CORS Fix + Deployment Guide - 2025-11-02

## Wat Was Het Probleem?

1. **Server crash**: `Cannot read properties of null (reading 'forEach')` in `/api/categories/grouped`
2. **CORS errors**: Client-side code maakte directe calls naar `https://api.wotis-cloud.com`

## Wat Is Gefixed?

### Fix 1: Defensive Null Check
**File**: `app/api/categories/grouped/route.ts`
- Toegevoegd: null check voor categories array
- Voorkomt crash als Supabase null teruggeeft

### Fix 2: CORS Fix
**Files**:
- `app/api/recipes/[slug]/route.ts` - Added `?includeIngredients=true` parameter
- `app/recipes/[slug]/cooking/page.tsx` - Changed from direct Supabase to API route

**Voor:**
```tsx
// Direct Supabase call (CORS error!)
const { data } = await supabase.from('recipes').select('*')
```

**Na:**
```tsx
// Via API route (no CORS!)
const response = await fetch(`/api/recipes/${slug}?includeIngredients=true`)
```

## Deployment Instructies

### 1. Open Coolify
- URL: `http://192.168.1.63:7000`

### 2. Deploy Type
**Gebruik**: **Force Deploy Without Cache**
- Waarom: Zorgt dat nieuwe code volledig rebuild wordt
- Environment variables worden dan opnieuw ingebakken

### 3. Environment Variables Check
**Moeten zo blijven staan:**
```
NEXT_PUBLIC_SUPABASE_URL=https://api.wotis-cloud.com  ✅ CORRECT
NEXT_PUBLIC_SUPABASE_ANON_KEY=[your-key]
SUPABASE_SERVICE_ROLE_KEY=[your-key]
GOOGLE_AI_API_KEY=[your-key]
NEXT_PUBLIC_APP_URL=https://kookboek.wotis-cloud.com
```

**NIET wijzigen naar:**
- ❌ `http://192.168.1.63:8000` (alleen voor local dev)

### 4. Deployment Stappen
1. Click **"Force Deploy Without Cache"**
2. Wacht 5-10 minuten
3. Check logs voor errors

### 5. Test Na Deployment
1. Open `http://192.168.1.63:3000`
2. Klik op een recept → Kookmodus
3. Open Browser Console (F12)
4. Check:
   - ✅ Geen CORS errors
   - ✅ Recepten laden
   - ✅ Ingrediënten laden
   - ✅ `/api/recipes/...?includeIngredients=true` in Network tab

## Commits
- `ac14a08` - Defensive null check
- `43e1dcc` - CORS fix via API routes

## Als Het Niet Werkt
Check container logs:
```bash
ssh wouter@192.168.1.63 "docker logs --tail 100 [container-name]"
```
